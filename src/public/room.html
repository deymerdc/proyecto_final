<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Video Chat Room</title>
    <link rel="stylesheet" href="styles.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <div id="main-content">
        <div id="video-section">
            <div id="video-grid">
                <div id="remote-video-container-1" class="video-container empty-slot">
                    <video id="remote-video-1" autoplay></video>
                    <div id="remote-status-1" class="status">Vídeo remoto 1</div>
                </div>
                <div id="remote-video-container-2" class="video-container empty-slot">
                    <video id="remote-video-2" autoplay></video>
                    <div id="remote-status-2" class="status">Vídeo remoto 2</div>
                </div>
                <div id="remote-video-container-3" class="video-container empty-slot">
                    <video id="remote-video-3" autoplay></video>
                    <div id="remote-status-3" class="status">Vídeo remoto 3</div>
                </div>
                <div id="remote-video-container-4" class="video-container empty-slot">
                    <video id="remote-video-4" autoplay></video>
                    <div id="remote-status-4" class="status">Vídeo remoto 4</div>
                </div>
            </div>
            <div id="control-container">
                <button id="btn-emit">Emitir</button>
                <button id="btn-ocultar">Ocultar</button>
                <button id="btn-toggle-mic">Encender Micrófono</button>
            </div>
        </div>
        <div id="chat-container">
            <ul id="messages"></ul>
            <form id="form">
                <input type="text" id="input" placeholder="Escribe un mensaje..." autocomplete="off">
                <button type="submit">Enviar</button>
            </form>
        </div>
    </div>

    <script>
        const socket = io();
        let username = localStorage.getItem('username');
        const urlParams = new URLSearchParams(window.location.search);
        const roomName = urlParams.get('name');
        let localStream;
        let streaming = false;
        let micEnabled = false;

        if (!username) {
            window.location.href = '/';
        }

        // Join the room
        socket.emit('join room', { roomName, username });

        const btnEmit = document.querySelector('#btn-emit');
        const btnOcultar = document.querySelector('#btn-ocultar');
        const btnToggleMic = document.querySelector('#btn-toggle-mic');
        const videoGrid = document.querySelector('#video-grid');

        async function startStream() {
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                const videoElement = document.querySelector(`#remote-video-${socket.slotIndex + 1}`);
                videoElement.srcObject = localStream;
                streaming = true;

                socket.emit('start stream', { username, slotIndex: socket.slotIndex });
                publicarMensaje(socket.slotIndex, 'Cámara funcionando');

                localStream.getVideoTracks()[0].onended = () => {
                    stopStream();
                };

                localStream.getAudioTracks()[0].onended = () => {
                    stopStream();
                };
            } catch (error) {
                console.error('Error accessing media devices:', error);
                publicarMensaje(socket.slotIndex, 'Error al acceder a la cámara');
            }
        }

        function stopStream() {
            streaming = false;
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                const remoteVideo = document.querySelector(`#remote-video-${socket.slotIndex + 1}`);
                remoteVideo.srcObject = null;
                publicarMensaje(socket.slotIndex, 'Cámara oculta');
                socket.emit('stop stream', { username, slotIndex: socket.slotIndex });
            }
        }

        btnEmit.addEventListener('click', startStream);

        btnOcultar.addEventListener('click', stopStream);

        function toggleMic(enable) {
            if (localStream) {
                localStream.getAudioTracks().forEach(track => {
                    track.enabled = enable;
                });
                micEnabled = enable;
                btnToggleMic.textContent = enable ? 'Apagar Micrófono' : 'Encender Micrófono';
            }
        }

        btnToggleMic.addEventListener('click', () => {
            if (socket.slotIndex !== undefined && socket.slotIndex !== null) {
                toggleMic(!micEnabled);
            } else {
                alert('Solo los usuarios con transmisión de video pueden encender el micrófono');
            }
        });

        socket.on('assign slot', ({ username, slotIndex }) => {
            socket.slotIndex = slotIndex;
            const remoteStatus = document.querySelector(`#remote-status-${slotIndex + 1}`);
            const remoteContainer = document.querySelector(`#remote-video-container-${slotIndex + 1}`);
            remoteStatus.innerText = `${username} en línea`;
            remoteContainer.classList.remove('empty-slot');
        });

        socket.on('release slot', ({ slotIndex }) => {
            const remoteStatus = document.querySelector(`#remote-status-${slotIndex + 1}`);
            const remoteVideo = document.querySelector(`#remote-video-${slotIndex + 1}`);
            remoteStatus.innerText = `Vídeo remoto ${slotIndex + 1}`;
            remoteVideo.srcObject = null;
            const remoteContainer = document.querySelector(`#remote-video-container-${slotIndex + 1}`);
            remoteContainer.classList.add('empty-slot');
        });

        socket.on('stream', ({ username, slotIndex, stream }) => {
            const remoteVideo = document.querySelector(`#remote-video-${slotIndex + 1}`);
            if (remoteVideo) {
                remoteVideo.srcObject = stream;
            }
        });

        // Chat functionality
        const form = document.getElementById('form');
        const input = document.getElementById('input');
        const messages = document.getElementById('messages');

        socket.on('chat message', ({ msg, username }) => {
            const item = document.createElement('li');
            item.textContent = `${username}: ${msg}`;
            messages.appendChild(item);
            messages.scrollTop = messages.scrollHeight;
        });

        form.addEventListener('submit', (e) => {
            e.preventDefault();
            if (input.value && username) {
                socket.emit('chat message', { msg: input.value, username, roomName });
                input.value = '';
            }
        });

        window.addEventListener('load', () => {
            if (!username) {
                username = prompt('Introduce tu nombre de usuario');
                localStorage.setItem('username', username);
            }
        });

        function publicarMensaje(slotIndex, msg) {
            const localStatus = document.querySelector(`#remote-status-${slotIndex + 1}`);
            if (localStatus) localStatus.innerText = msg;
        }
    </script>
</body>
</html>
